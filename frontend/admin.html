<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>åå°ç®¡ç† - å±å¹•ä»“</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: #0b1021;
      color: #e5e7eb;
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 1400px; margin: 0 auto; }
    h1 { color: #fff; margin-bottom: 20px; }
    
    .login-box {
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      margin: 100px auto;
    }
    .login-box h2 { color: #fff; margin-bottom: 16px; }
    .login-box input {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      font-size: 16px;
      margin-bottom: 12px;
    }
    
    .btn {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      color: #fff;
    }
    .btn-success { background: #22c55e; color: #fff; }
    .btn-danger { background: #ef4444; color: #fff; }
    .btn-warning { background: #f59e0b; color: #000; }
    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: #9ca3af;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-sm { padding: 6px 12px; font-size: 13px; }
    
    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 10px 20px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: #9ca3af;
      cursor: pointer;
    }
    .tab.active {
      background: linear-gradient(135deg, #2563eb, #7c3aed);
      color: #fff;
      border: none;
    }
    
    .panel {
      background: rgba(15, 23, 42, 0.75);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 12px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    th { color: #9ca3af; font-weight: 500; font-size: 13px; }
    tr:hover { background: rgba(255, 255, 255, 0.02); }
    
    .status {
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .status-pending { background: #fbbf24; color: #000; }
    .status-processing { background: #3b82f6; color: #fff; }
    .status-completed { background: #22c55e; color: #fff; }
    .status-cancelled { background: #ef4444; color: #fff; }
    
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
    .header-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    
    .empty { text-align: center; padding: 40px; color: #9ca3af; }
    
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    .modal {
      background: #1e293b;
      border-radius: 16px;
      padding: 24px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .modal h3 { color: #fff; margin-bottom: 20px; }
    .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
    
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; color: #9ca3af; font-size: 14px; margin-bottom: 6px; }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
      color: #fff;
      font-size: 14px;
    }
    .form-group textarea { resize: vertical; min-height: 80px; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #3b82f6; }
    
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      padding: 20px;
      border-radius: 12px;
    }
    .stat-card .value { font-size: 32px; font-weight: 700; }
    .stat-card .label { color: #9ca3af; margin-top: 4px; }
    
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .alert-warning {
      background: rgba(245, 158, 11, 0.15);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: #fbbf24;
    }
    
    .actions-cell { white-space: nowrap; }
    .actions-cell .btn { margin-right: 4px; }

    .order-items {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 8px;
      padding: 12px;
      margin-top: 12px;
    }
    .order-items h4 { color: #9ca3af; font-size: 13px; margin-bottom: 8px; }
    .order-item-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    .order-item-row:last-child { border-bottom: none; }

    @media (max-width: 768px) {
      table { font-size: 13px; }
      th, td { padding: 8px 4px; }
      .form-row { grid-template-columns: 1fr; }
      .modal { padding: 16px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loginBox" class="login-box">
      <h2>ğŸ” ç®¡ç†å‘˜ç™»å½•</h2>
      <input type="password" id="tokenInput" placeholder="è¯·è¾“å…¥ç®¡ç†å‘˜ä»¤ç‰Œ (ADMIN_TOKEN)" />
      <button class="btn btn-primary" style="width:100%" onclick="login()">ç™»å½•</button>
      <p id="loginError" style="color: #ef4444; margin-top: 12px; display: none;"></p>
    </div>

    <div id="adminPanel" style="display: none;">
      <div class="header">
        <h1>ğŸ“Š åå°ç®¡ç†ç³»ç»Ÿ</h1>
        <button class="btn btn-secondary" onclick="logout()">é€€å‡ºç™»å½•</button>
      </div>

      <div class="tabs">
        <button class="tab active" data-tab="orders">ğŸ“¦ è®¢å•ç®¡ç†</button>
        <button class="tab" data-tab="products">ğŸ›’ äº§å“ç®¡ç†</button>
        <button class="tab" data-tab="stats">ğŸ“ˆ ç»Ÿè®¡æ•°æ®</button>
      </div>

      <div id="ordersPanel" class="panel">
        <div class="header">
          <h2>è®¢å•åˆ—è¡¨</h2>
          <div class="header-actions">
            <select id="orderStatusFilter" onchange="loadOrders()" style="padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: #fff;">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="pending">å¾…å¤„ç†</option>
              <option value="processing">å¤„ç†ä¸­</option>
              <option value="completed">å·²å®Œæˆ</option>
              <option value="cancelled">å·²å–æ¶ˆ</option>
            </select>
            <button class="btn btn-primary" onclick="loadOrders()">ğŸ”„ åˆ·æ–°</button>
          </div>
        </div>
        <div id="ordersList"></div>
      </div>

      <div id="productsPanel" class="panel" style="display: none;">
        <div class="header">
          <h2>äº§å“åˆ—è¡¨</h2>
          <div class="header-actions">
            <button class="btn btn-success" onclick="showProductModal()">+ æ·»åŠ äº§å“</button>
            <button class="btn btn-primary" onclick="loadProducts()">ğŸ”„ åˆ·æ–°</button>
          </div>
        </div>
        <div id="productsList"></div>
      </div>

      <div id="statsPanel" class="panel" style="display: none;">
        <h2>ç»Ÿè®¡æ•°æ®</h2>
        <div id="statsContent" style="margin-top: 20px;"></div>
      </div>
    </div>
  </div>

  <div id="productModal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <h3 id="productModalTitle">æ·»åŠ äº§å“</h3>
      <input type="hidden" id="productId" />
      <div class="form-row">
        <div class="form-group">
          <label>äº§å“åç§° *</label>
          <input type="text" id="productName" placeholder="å¦‚ï¼šiPhone 15 Pro å±å¹•ç»„ä»¶" />
        </div>
        <div class="form-group">
          <label>ä»·æ ¼ (Â¥) *</label>
          <input type="number" id="productPrice" step="0.01" placeholder="0.00" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>åº“å­˜æ•°é‡ *</label>
          <input type="number" id="productStock" placeholder="0" />
        </div>
        <div class="form-group">
          <label>å›¾ç‰‡ URL</label>
          <input type="text" id="productImage" placeholder="https://..." />
        </div>
      </div>
      <div class="form-group">
        <label>äº§å“æè¿°</label>
        <textarea id="productDesc" placeholder="äº§å“æè¿°ä¿¡æ¯..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeProductModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveProduct()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div id="orderModal" class="modal-overlay" style="display: none;">
    <div class="modal">
      <h3>ç¼–è¾‘è®¢å• #<span id="orderModalId"></span></h3>
      <input type="hidden" id="orderId" />
      <div class="form-row">
        <div class="form-group">
          <label>å®¢æˆ·å§“å</label>
          <input type="text" id="orderCustomerName" />
        </div>
        <div class="form-group">
          <label>è”ç³»ç”µè¯</label>
          <input type="text" id="orderPhone" />
        </div>
      </div>
      <div class="form-group">
        <label>æ”¶è´§åœ°å€</label>
        <textarea id="orderAddress"></textarea>
      </div>
      <div class="form-group">
        <label>è®¢å•çŠ¶æ€</label>
        <select id="orderStatus">
          <option value="pending">å¾…å¤„ç†</option>
          <option value="processing">å¤„ç†ä¸­</option>
          <option value="completed">å·²å®Œæˆ</option>
          <option value="cancelled">å·²å–æ¶ˆ</option>
        </select>
      </div>
      <div id="orderItemsDetail" class="order-items"></div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeOrderModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveOrder()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <div id="confirmModal" class="modal-overlay" style="display: none;">
    <div class="modal" style="max-width: 400px; text-align: center;">
      <h3 style="color: #ef4444;">âš ï¸ ç¡®è®¤åˆ é™¤</h3>
      <p id="confirmMessage" style="margin: 20px 0; color: #9ca3af;"></p>
      <div class="modal-actions" style="justify-content: center;">
        <button class="btn btn-secondary" onclick="closeConfirmModal()">å–æ¶ˆ</button>
        <button class="btn btn-danger" id="confirmDeleteBtn">ç¡®è®¤åˆ é™¤</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let token = localStorage.getItem('adminToken') || '';

    if (token) verifyToken();

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        const tabName = tab.dataset.tab;
        document.getElementById('ordersPanel').style.display = tabName === 'orders' ? 'block' : 'none';
        document.getElementById('productsPanel').style.display = tabName === 'products' ? 'block' : 'none';
        document.getElementById('statsPanel').style.display = tabName === 'stats' ? 'block' : 'none';
        if (tabName === 'orders') loadOrders();
        if (tabName === 'products') loadProducts();
        if (tabName === 'stats') loadStats();
      });
    });

    async function verifyToken() {
      try {
        const res = await fetch(`${API_BASE}/api/orders`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) showAdminPanel();
        else { localStorage.removeItem('adminToken'); token = ''; }
      } catch (e) { console.error(e); }
    }

    async function login() {
      token = document.getElementById('tokenInput').value.trim();
      if (!token) return;
      try {
        const res = await fetch(`${API_BASE}/api/orders`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
          localStorage.setItem('adminToken', token);
          showAdminPanel();
        } else { showError('loginError', 'ä»¤ç‰Œæ— æ•ˆ'); }
      } catch (e) { showError('loginError', 'è¿æ¥å¤±è´¥'); }
    }

    function logout() { localStorage.removeItem('adminToken'); location.reload(); }

    function showAdminPanel() {
      document.getElementById('loginBox').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'block';
      loadOrders();
    }

    function showError(id, msg) {
      const el = document.getElementById(id);
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 3000);
    }

    const statusMap = {
      pending: { text: 'å¾…å¤„ç†', class: 'status-pending' },
      processing: { text: 'å¤„ç†ä¸­', class: 'status-processing' },
      completed: { text: 'å·²å®Œæˆ', class: 'status-completed' },
      cancelled: { text: 'å·²å–æ¶ˆ', class: 'status-cancelled' }
    };

    async function loadOrders() {
      const filter = document.getElementById('orderStatusFilter').value;
      try {
        const res = await fetch(`${API_BASE}/api/orders`, { headers: { 'Authorization': `Bearer ${token}` } });
        let orders = await res.json();
        if (filter) orders = orders.filter(o => o.status === filter);

        if (orders.length === 0) {
          document.getElementById('ordersList').innerHTML = '<div class="empty">æš‚æ— è®¢å•</div>';
          return;
        }

        let html = `<table><thead><tr><th>è®¢å•å·</th><th>å®¢æˆ·</th><th>ç”µè¯</th><th>åœ°å€</th><th>é‡‘é¢</th><th>çŠ¶æ€</th><th>æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>`;
        orders.forEach(order => {
          const status = statusMap[order.status] || statusMap.pending;
          html += `<tr>
            <td><strong>#${order.id}</strong></td>
            <td>${order.customer_name}</td>
            <td><a href="tel:${order.phone}" style="color:#60a5fa">${order.phone}</a></td>
            <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis">${order.address}</td>
            <td style="color:#a5b4fc;font-weight:600">Â¥${order.total.toFixed(2)}</td>
            <td><span class="status ${status.class}">${status.text}</span></td>
            <td style="font-size:12px;color:#9ca3af">${new Date(order.created_at).toLocaleString('zh-CN')}</td>
            <td class="actions-cell">
              <button class="btn btn-primary btn-sm" onclick="editOrder(${order.id})">ç¼–è¾‘</button>
              <button class="btn btn-danger btn-sm" onclick="confirmDeleteOrder(${order.id})">åˆ é™¤</button>
            </td>
          </tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('ordersList').innerHTML = html;
      } catch (e) { document.getElementById('ordersList').innerHTML = '<div class="empty">åŠ è½½å¤±è´¥</div>'; }
    }

    async function editOrder(id) {
      try {
        const res = await fetch(`${API_BASE}/api/orders/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
        const order = await res.json();
        document.getElementById('orderId').value = order.id;
        document.getElementById('orderModalId').textContent = order.id;
        document.getElementById('orderCustomerName').value = order.customer_name;
        document.getElementById('orderPhone').value = order.phone;
        document.getElementById('orderAddress').value = order.address;
        document.getElementById('orderStatus').value = order.status || 'pending';

        let itemsHtml = '<h4>è®¢å•å•†å“</h4>';
        if (order.items && order.items.length) {
          order.items.forEach(item => {
            itemsHtml += `<div class="order-item-row"><span>${item.product_name || 'äº§å“#' + item.product_id} Ã— ${item.quantity}</span><span style="color:#a5b4fc">Â¥${(item.unit_price * item.quantity).toFixed(2)}</span></div>`;
          });
          itemsHtml += `<div class="order-item-row" style="font-weight:600;border-top:1px solid rgba(255,255,255,0.1);margin-top:8px;padding-top:8px"><span>åˆè®¡</span><span style="color:#22c55e">Â¥${order.total.toFixed(2)}</span></div>`;
        }
        document.getElementById('orderItemsDetail').innerHTML = itemsHtml;
        document.getElementById('orderModal').style.display = 'flex';
      } catch (e) { alert('è·å–è®¢å•è¯¦æƒ…å¤±è´¥'); }
    }

    async function saveOrder() {
      const id = document.getElementById('orderId').value;
      const data = {
        customerName: document.getElementById('orderCustomerName').value,
        phone: document.getElementById('orderPhone').value,
        address: document.getElementById('orderAddress').value,
        status: document.getElementById('orderStatus').value
      };
      try {
        const res = await fetch(`${API_BASE}/api/orders/${id}`, {
          method: 'PUT',
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (res.ok) { closeOrderModal(); loadOrders(); }
        else { const err = await res.json(); alert(err.message || 'ä¿å­˜å¤±è´¥'); }
      } catch (e) { alert('ä¿å­˜å¤±è´¥'); }
    }

    function closeOrderModal() { document.getElementById('orderModal').style.display = 'none'; }

    function confirmDeleteOrder(id) {
      document.getElementById('confirmMessage').textContent = `ç¡®å®šè¦åˆ é™¤è®¢å• #${id} å—ï¼Ÿåˆ é™¤ååº“å­˜å°†è‡ªåŠ¨æ¢å¤ã€‚`;
      document.getElementById('confirmDeleteBtn').onclick = () => deleteOrder(id);
      document.getElementById('confirmModal').style.display = 'flex';
    }

    async function deleteOrder(id) {
      try {
        const res = await fetch(`${API_BASE}/api/orders/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
        if (res.ok) { closeConfirmModal(); loadOrders(); }
        else { const err = await res.json(); alert(err.message || 'åˆ é™¤å¤±è´¥'); }
      } catch (e) { alert('åˆ é™¤å¤±è´¥'); }
    }

    async function loadProducts() {
      try {
        const res = await fetch(`${API_BASE}/api/products`);
        const products = await res.json();
        if (products.length === 0) { document.getElementById('productsList').innerHTML = '<div class="empty">æš‚æ— äº§å“</div>'; return; }

        let html = `<table><thead><tr><th>ID</th><th>å›¾ç‰‡</th><th>åç§°</th><th>ä»·æ ¼</th><th>åº“å­˜</th><th>æè¿°</th><th>æ“ä½œ</th></tr></thead><tbody>`;
        products.forEach(p => {
          const stockColor = p.stock < 10 ? '#ef4444' : '#22c55e';
          html += `<tr>
            <td>${p.id}</td>
            <td><img src="${p.image || 'https://via.placeholder.com/50'}" style="width:50px;height:50px;object-fit:cover;border-radius:8px" /></td>
            <td><strong>${p.name}</strong></td>
            <td style="color:#a5b4fc;font-weight:600">Â¥${p.price.toFixed(2)}</td>
            <td style="color:${stockColor};font-weight:600">${p.stock}</td>
            <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;color:#9ca3af">${p.description || '-'}</td>
            <td class="actions-cell">
              <button class="btn btn-primary btn-sm" onclick="editProduct(${p.id})">ç¼–è¾‘</button>
              <button class="btn btn-danger btn-sm" onclick="confirmDeleteProduct(${p.id}, '${p.name.replace(/'/g, "\\'")}')">åˆ é™¤</button>
            </td>
          </tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('productsList').innerHTML = html;
      } catch (e) { document.getElementById('productsList').innerHTML = '<div class="empty">åŠ è½½å¤±è´¥</div>'; }
    }

    function showProductModal(product = null) {
      document.getElementById('productModalTitle').textContent = product ? 'ç¼–è¾‘äº§å“' : 'æ·»åŠ äº§å“';
      document.getElementById('productId').value = product?.id || '';
      document.getElementById('productName').value = product?.name || '';
      document.getElementById('productPrice').value = product?.price || '';
      document.getElementById('productStock').value = product?.stock ?? '';
      document.getElementById('productImage').value = product?.image || '';
      document.getElementById('productDesc').value = product?.description || '';
      document.getElementById('productModal').style.display = 'flex';
    }

    async function editProduct(id) {
      try {
        const res = await fetch(`${API_BASE}/api/products`);
        const products = await res.json();
        const product = products.find(p => p.id === id);
        if (product) showProductModal(product);
      } catch (e) { alert('è·å–äº§å“å¤±è´¥'); }
    }

    async function saveProduct() {
      const id = document.getElementById('productId').value;
      const data = {
        name: document.getElementById('productName').value,
        price: parseFloat(document.getElementById('productPrice').value),
        stock: parseInt(document.getElementById('productStock').value),
        image: document.getElementById('productImage').value,
        description: document.getElementById('productDesc').value
      };
      if (!data.name || isNaN(data.price)) { alert('è¯·å¡«å†™äº§å“åç§°å’Œä»·æ ¼'); return; }

      try {
        const url = id ? `${API_BASE}/api/products/${id}` : `${API_BASE}/api/products`;
        const method = id ? 'PUT' : 'POST';
        const res = await fetch(url, {
          method,
          headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (res.ok) { closeProductModal(); loadProducts(); }
        else { const err = await res.json(); alert(err.message || 'ä¿å­˜å¤±è´¥'); }
      } catch (e) { alert('ä¿å­˜å¤±è´¥'); }
    }

    function closeProductModal() { document.getElementById('productModal').style.display = 'none'; }

    function confirmDeleteProduct(id, name) {
      document.getElementById('confirmMessage').textContent = `ç¡®å®šè¦åˆ é™¤äº§å“ã€Œ${name}ã€å—ï¼Ÿ`;
      document.getElementById('confirmDeleteBtn').onclick = () => deleteProduct(id);
      document.getElementById('confirmModal').style.display = 'flex';
    }

    async function deleteProduct(id) {
      try {
        const res = await fetch(`${API_BASE}/api/products/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
        if (res.ok) { closeConfirmModal(); loadProducts(); }
        else { const err = await res.json(); alert(err.message || 'åˆ é™¤å¤±è´¥'); }
      } catch (e) { alert('åˆ é™¤å¤±è´¥'); }
    }

    function closeConfirmModal() { document.getElementById('confirmModal').style.display = 'none'; }

    async function loadStats() {
      try {
        const [ordersRes, productsRes] = await Promise.all([
          fetch(`${API_BASE}/api/orders`, { headers: { 'Authorization': `Bearer ${token}` } }),
          fetch(`${API_BASE}/api/products`)
        ]);
        const orders = await ordersRes.json();
        const products = await productsRes.json();

        const completedOrders = orders.filter(o => o.status === 'completed');
        const pendingOrders = orders.filter(o => o.status === 'pending');
        const totalRevenue = completedOrders.reduce((sum, o) => sum + o.total, 0);
        const pendingRevenue = pendingOrders.reduce((sum, o) => sum + o.total, 0);
        const totalStock = products.reduce((sum, p) => sum + p.stock, 0);
        const lowStockProducts = products.filter(p => p.stock < 10);

        let html = `<div class="stats-grid">
          <div class="stat-card" style="background:rgba(37,99,235,0.2)"><div class="value" style="color:#60a5fa">${orders.length}</div><div class="label">æ€»è®¢å•æ•°</div></div>
          <div class="stat-card" style="background:rgba(251,191,36,0.2)"><div class="value" style="color:#fbbf24">${pendingOrders.length}</div><div class="label">å¾…å¤„ç†è®¢å•</div></div>
          <div class="stat-card" style="background:rgba(34,197,94,0.2)"><div class="value" style="color:#4ade80">Â¥${totalRevenue.toFixed(2)}</div><div class="label">å·²å®Œæˆè¥æ”¶</div></div>
          <div class="stat-card" style="background:rgba(168,85,247,0.2)"><div class="value" style="color:#c084fc">Â¥${pendingRevenue.toFixed(2)}</div><div class="label">å¾…å¤„ç†é‡‘é¢</div></div>
          <div class="stat-card" style="background:rgba(59,130,246,0.2)"><div class="value" style="color:#3b82f6">${products.length}</div><div class="label">äº§å“æ•°é‡</div></div>
          <div class="stat-card" style="background:rgba(20,184,166,0.2)"><div class="value" style="color:#2dd4bf">${totalStock}</div><div class="label">æ€»åº“å­˜</div></div>
        </div>`;

        if (lowStockProducts.length > 0) {
          html += `<div class="alert alert-warning"><strong>âš ï¸ åº“å­˜é¢„è­¦ï¼š</strong>ä»¥ä¸‹äº§å“åº“å­˜ä¸è¶³ 10 ä»¶ï¼š<br>${lowStockProducts.map(p => `${p.name}ï¼ˆå‰©ä½™ ${p.stock}ï¼‰`).join('ã€')}</div>`;
        }
        document.getElementById('statsContent').innerHTML = html;
      } catch (e) { document.getElementById('statsContent').innerHTML = '<div class="empty">åŠ è½½å¤±è´¥</div>'; }
    }

    document.getElementById('tokenInput').addEventListener('keyup', (e) => { if (e.key === 'Enter') login(); });
    document.addEventListener('keyup', (e) => { if (e.key === 'Escape') { closeProductModal(); closeOrderModal(); closeConfirmModal(); } });
  </script>
</body>
</html>
